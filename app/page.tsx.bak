import React from "react";
import { sanityFetch } from "@/sanity/lib/live";
import { Hero } from "./components/Hero";
import { ProjectList, type Project } from "./components/ProjectList";
import { logger, logError } from "@/liblogger";
import { projectId } from "@/sanity/env";

export default async function Home() {
  logger.info({ event: 'page_render', page: 'Home' }, 'Rendering Home Page started');

  // Sprawdzamy czy konfiguracja jest poprawna
  if (!projectId || projectId === 'no-project-id') {
    logger.fatal({ missingVar: 'NEXT_PUBLIC_SANITY_PROJECT_ID' }, 'Critical configuration missing');
    
    return (
      <main className="min-h-screen flex flex-col items-center justify-center bg-black text-red-500 font-mono p-4 text-center">
        <h1 className="text-4xl mb-4 font-bold tracking-tighter">SYSTEM OFFLINE</h1>
        <div className="border border-red-900/50 p-6 rounded-lg bg-red-950/10 backdrop-blur-sm max-w-lg">
          <p className="font-bold mb-2">CRITICAL ERROR: MISSING PROJECT ID.</p>
          <span className="text-sm opacity-70 block leading-relaxed">
            Connection to Neural Matrix (CMS) failed. <br/>
            Please configure <code>NEXT_PUBLIC_SANITY_PROJECT_ID</code> in your <code>.env.local</code> file.
          </span>
        </div>
      </main>
    );
  }

  const query = \*[_type == "project"] | order(_createdAt asc) {
    _id, title, subtitle, description, repoLink, tags, color, iconType, image
  }\;

  let projects: Project[] = [];
  let isError = false;
  
  try {
    logger.debug({ query }, 'Executing Sanity Query');
    
    const result = await sanityFetch({ query });
    projects = (result.data as Project[]) || [];
    
    logger.info({ count: projects.length }, 'Successfully fetched projects');
    
  } catch (error) {
    logError(error, 'Home.sanityFetch');
    isError = true;
  }

  return (
    <main className="min-h-screen bg-black text-white selection:bg-emerald-500/30">
      <Hero isConfigured={!isError} />
      
      {projects.length > 0 ? (
        <ProjectList projects={projects} />
      ) : (
        <div className="py-20 text-center font-mono text-emerald-600/50">
          {isError ? "[ CONNECTION INTERRUPTED - CHECK LOGS ]" : "[ NO ARTIFACTS FOUND ]"}
        </div>
      )}
    </main>
  );
}